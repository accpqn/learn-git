"use strict";const e=require("../../common/vendor.js"),r=require("../../store/order.js"),t=require("../../config/index.js"),o=require("../../api/order.js"),d={setup(){const d=r.useOrderStore(),a=e.ref(!1);e.onLoad((e=>{e.id&&(console.log("Loading order detail for ID:",e.id),d.fetchOrderDetail(e.id))}));const s=t.getProductImageUrl,c=e.computed((()=>{const e=d.currentOrderDetail;return!!e&&("received"===e.type&&"PENDING"===e.status||["PENDING","CONFIRMED","ORDERED"].includes(e.status))})),i=e.computed((()=>{const e=d.currentOrderDetail;return e&&["PENDING","CONFIRMED","ORDERED"].includes(e.status)})),n=async r=>{try{console.log("Updating order status to:",r),await o.updateOrderStatus(d.currentOrderDetail.id,{status:r}),d.currentOrderDetail.status=r;const t=d.sentOrders.findIndex((e=>e.id===d.currentOrderDetail.id)),a=d.receivedOrders.findIndex((e=>e.id===d.currentOrderDetail.id));-1!==t&&(d.sentOrders[t].status=r),-1!==a&&(d.receivedOrders[a].status=r),d.saveOrdersToLocal(),e.index.showToast({title:"状态更新成功",icon:"success"})}catch(t){console.error("Update status failed:",t),e.index.showToast({title:"更新失败: "+(t.message||"网络错误"),icon:"none"})}};return{orderStore:d,accepting:a,showOrderActions:c,canUpdateStatus:i,formatDate:r=>r?e.dayjs(r).format("YYYY-MM-DD HH:mm"):"未知",getStatusText:e=>({PENDING:"待处理",CONFIRMED:"已确认",ORDERED:"已下单",COMPLETED:"已完成",RATED:"已评价",CANCELLED:"已取消",pending:"待处理",accepted:"已接收",completed:"已完成"}[e]||"未知"),getStatusClass:e=>`status-${e}`,getProductImageUrl:s,acceptOrder:async()=>{a.value=!0;try{console.log("Accepting order:",d.currentOrderDetail.id),await o.updateOrderStatus(d.currentOrderDetail.id,{status:"CONFIRMED"}),d.currentOrderDetail.status="CONFIRMED";const r=d.receivedOrders.findIndex((e=>e.id===d.currentOrderDetail.id));-1!==r&&(d.receivedOrders[r].status="CONFIRMED"),d.saveOrdersToLocal(),e.index.showToast({title:"订单已接受",icon:"success"})}catch(r){console.error("Accept order failed:",r),e.index.showToast({title:"接受失败: "+(r.message||"网络错误"),icon:"none"})}finally{a.value=!1}},showStatusOptions:()=>{const r=[{text:"已确认",value:"CONFIRMED"},{text:"已下单",value:"ORDERED"},{text:"已完成",value:"COMPLETED"},{text:"取消订单",value:"CANCELLED"}];e.index.showActionSheet({itemList:r.map((e=>e.text)),success:e=>{const t=r[e.tapIndex];n(t.value)}})},updateOrderStatusLocal:n}}};if(!Array){(e.resolveComponent("u-loading-page")+e.resolveComponent("u-empty"))()}const a=e._export_sfc(d,[["render",function(r,t,o,d,a,s){return e.e({a:"loading"===d.orderStore.status},"loading"===d.orderStore.status?{b:e.p({"loading-text":"正在加载订单详情..."})}:d.orderStore.currentOrderDetail?e.e({d:e.t(d.orderStore.currentOrderDetail.id),e:e.t("sent"===d.orderStore.currentOrderDetail.type?"发给TA的订单":"来自TA的订单"),f:e.t(d.getStatusText(d.orderStore.currentOrderDetail.status)),g:e.n(d.getStatusClass(d.orderStore.currentOrderDetail.status)),h:e.t(d.formatDate(d.orderStore.currentOrderDetail.created_at||d.orderStore.currentOrderDetail.createTime)),i:e.t(d.orderStore.currentOrderDetail.creator_username||"未知"),j:e.t(d.orderStore.currentOrderDetail.total_price||d.orderStore.currentOrderDetail.totalPrice),k:d.orderStore.currentOrderDetail.notes||d.orderStore.currentOrderDetail.note},d.orderStore.currentOrderDetail.notes||d.orderStore.currentOrderDetail.note?{l:e.t(d.orderStore.currentOrderDetail.notes||d.orderStore.currentOrderDetail.note)}:{},{m:e.t(d.orderStore.currentOrderDetail.items.length),n:e.f(d.orderStore.currentOrderDetail.items,((r,t,o)=>({a:d.getProductImageUrl(r.product||r.item),b:e.t((r.product||r.item).name),c:e.t((r.product||r.item).description),d:e.t(r.price||(r.product||r.item).price),e:e.t(r.quantity),f:e.t(((r.price||(r.product||r.item).price)*r.quantity).toFixed(2)),g:t}))),o:d.showOrderActions},d.showOrderActions?e.e({p:"received"===d.orderStore.currentOrderDetail.type&&"PENDING"===d.orderStore.currentOrderDetail.status},"received"===d.orderStore.currentOrderDetail.type&&"PENDING"===d.orderStore.currentOrderDetail.status?{q:e.t(d.accepting?"处理中...":"接受订单"),r:e.o(((...e)=>d.acceptOrder&&d.acceptOrder(...e))),s:d.accepting}:{},{t:d.canUpdateStatus},d.canUpdateStatus?{v:e.o(((...e)=>d.showStatusOptions&&d.showStatusOptions(...e)))}:{}):{}):{w:e.p({text:"订单不存在",mode:"data"})},{c:d.orderStore.currentOrderDetail})}]]);wx.createPage(a);
