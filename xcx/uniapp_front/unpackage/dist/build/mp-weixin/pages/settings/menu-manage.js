"use strict";const e=require("../../common/vendor.js"),o=require("../../api/menu.js"),t=require("../../config/index.js"),r=require("../../mixins/theme.js"),a=require("../../store/theme.js"),i={name:"MenuManage",setup(){const{currentTheme:i,getThemeColor:c,getButtonStyle:l,getHeaderStyle:n}=r.useTheme(),s=a.useThemeStore(),d=e.ref([]),g=e.ref([]),u=e.ref(!1),m=e.ref(0),y=e.ref(!1),h=e.reactive({id:null,name:"",description:""}),p=e.ref(!1),w=e.reactive({id:null,name:"",price:"",category:null,categoryIndex:0,description:"",imageUrl:"",imageFile:null}),v=e.computed((()=>d.value.map((e=>e.name))));e.onMounted((()=>{C()})),e.onShow((()=>{try{e.index.setNavigationBarColor({frontColor:"#ffffff",backgroundColor:s.currentTheme.primaryColor,animation:{duration:0,timingFunc:"linear"}})}catch(o){console.log("设置导航栏主题失败:",o)}e.index.$emit("onPageShow","pages/settings/menu-manage")}));const C=async()=>{u.value=!0;try{await Promise.all([f(),P()])}catch(o){console.error("加载数据失败:",o),e.index.showToast({title:"加载数据失败",icon:"error"})}finally{u.value=!1}},f=async()=>{try{const e=await o.getCategories();d.value=e.sort(((e,o)=>(e.sort_order||0)-(o.sort_order||0)))}catch(e){console.error("加载分类失败:",e)}},P=async()=>{try{const e=await o.getProducts();g.value=e.sort(((e,o)=>(e.sort_order||0)-(o.sort_order||0)))}catch(e){console.error("加载商品失败:",e)}},M=t.getProductImageUrl,T=e=>g.value.filter((o=>o.category===e)).length,x=()=>{h.id=null,h.name="",h.description=""},F=()=>{w.id=null,w.name="",w.price="",w.category=d.value.length>0?d.value[0].id:null,w.categoryIndex=0,w.description="",w.imageUrl="",w.imageFile=null},I=(o,r,a,i)=>new Promise(((c,l)=>{const n=i?`${t.config.API_BASE_URL}/api/menus/products/${o}/`:`${t.config.API_BASE_URL}/api/menus/products/`,s=e.index.getStorageSync("token");e.index.uploadFile({url:n,filePath:a,name:"image",formData:{...r,_method:i?"PUT":"POST"},header:{Authorization:`Bearer ${s}`},success:e=>{console.log("上传成功:",e),200===e.statusCode||201===e.statusCode?c(JSON.parse(e.data)):l(new Error(`上传失败: ${e.statusCode}`))},fail:e=>{console.error("上传失败:",e),l(e)}})}));return{categories:d,products:g,loading:u,currentTab:m,showCategoryModal:y,categoryForm:h,showProductModal:p,productForm:w,categoryOptions:v,loadData:C,switchTab:e=>{m.value=e},getProductImageUrl:M,getCategoryProductCount:T,getCategoryName:e=>{const o=d.value.find((o=>o.id===e));return o?o.name:"未知分类"},showAddCategoryModal:()=>{console.log("显示添加分类弹窗"),x(),y.value=!0},editCategory:e=>{h.id=e.id,h.name=e.name,h.description=e.description||"",y.value=!0},saveCategoryModal:async()=>{if(console.log("保存分类开始",h),h.name.trim())try{const t={name:h.name.trim(),description:h.description.trim()};if(console.log("准备发送的数据:",t),h.id)console.log("编辑分类:",h.id),await o.updateCategory(h.id,t),e.index.showToast({title:"分类更新成功",icon:"success"});else{console.log("新增分类");const r=await o.addCategory(t);console.log("新增分类结果:",r),e.index.showToast({title:"分类添加成功",icon:"success"})}y.value=!1,await f()}catch(t){console.error("保存分类失败:",t),e.index.showToast({title:"保存失败: "+(t.message||"未知错误"),icon:"error"})}else e.index.showToast({title:"请输入分类名称",icon:"error"})},closeCategoryModal:()=>{y.value=!1,x()},deleteCategory:t=>{const r=T(t.id),a=r>0?`分类"${t.name}"下有${r}个商品，删除分类将同时删除所有商品，确定要删除吗？`:`确定要删除分类"${t.name}"吗？`;e.index.showModal({title:"确认删除",content:a,success:async r=>{if(r.confirm)try{await o.deleteCategory(t.id),e.index.showToast({title:"删除成功",icon:"success"}),await C()}catch(a){console.error("删除分类失败:",a),e.index.showToast({title:"删除失败",icon:"error"})}}})},showAddProductModal:(o=null)=>{if(console.log("显示添加商品弹窗",o),0!==d.value.length){if(F(),o){const e=d.value.findIndex((e=>e.id===o));e>-1&&(w.category=o,w.categoryIndex=e)}p.value=!0}else e.index.showToast({title:"请先添加分类",icon:"error"})},editProduct:e=>{w.id=e.id,w.name=e.name,w.price=e.price.toString(),w.category=e.category,w.categoryIndex=d.value.findIndex((o=>o.id===e.category)),w.description=e.description||"",w.imageUrl=M(e),p.value=!0},handleCategoryChange:e=>{var o;const t=e.detail?e.detail.value:e.target.value;w.categoryIndex=t,w.category=null==(o=d.value[t])?void 0:o.id,console.log("分类选择变化:",t,w.category)},chooseImage:()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{w.imageUrl=e.tempFilePaths[0],w.imageFile=e.tempFiles[0],console.log("选择图片:",e.tempFilePaths[0])},fail:o=>{console.error("选择图片失败:",o),o.errMsg&&o.errMsg.includes("cancel")?e.index.showToast({title:"图片留着不添加，谁知道长什么样",icon:"none",duration:2e3}):e.index.showToast({title:"选择图片失败",icon:"error"})}})},removeImage:()=>{w.imageUrl="",w.imageFile=null},uploadProductWithImage:I,saveProductModal:async()=>{if(console.log("保存商品开始",w),w.name.trim())if(!w.price||parseFloat(w.price)<=0)e.index.showToast({title:"请输入有效价格",icon:"error"});else if(w.category)try{const t={name:w.name.trim(),price:parseFloat(w.price),category:w.category,description:w.description.trim()};console.log("准备发送的商品数据:",t),w.id?(console.log("编辑商品:",w.id),w.imageFile?await I(w.id,t,w.imageUrl,!0):await o.updateProduct(w.id,t),e.index.showToast({title:"商品更新成功",icon:"success"})):(console.log("新增商品"),w.imageFile?await I(null,t,w.imageUrl,!1):await o.addProduct(t),e.index.showToast({title:"商品添加成功",icon:"success"})),p.value=!1,await P()}catch(t){console.error("保存商品失败:",t),e.index.showToast({title:"保存失败: "+(t.message||"未知错误"),icon:"error"})}else e.index.showToast({title:"请选择分类",icon:"error"});else e.index.showToast({title:"请输入商品名称",icon:"error"})},closeProductModal:()=>{p.value=!1,F()},deleteProduct:t=>{e.index.showModal({title:"确认删除",content:`确定要删除商品"${t.name}"吗？`,success:async r=>{if(r.confirm)try{await o.deleteProduct(t.id),e.index.showToast({title:"删除成功",icon:"success"}),await P()}catch(a){console.error("删除商品失败:",a),e.index.showToast({title:"删除失败",icon:"error"})}}})},currentTheme:i,getThemeColor:c,getButtonStyle:l,getHeaderStyle:n}}};const c=e._export_sfc(i,[["render",function(o,t,r,a,i,c){return e.e({a:0===a.currentTab?1:"",b:e.o((e=>a.switchTab(0))),c:1===a.currentTab?1:"",d:e.o((e=>a.switchTab(1))),e:0===a.currentTab},0===a.currentTab?e.e({f:e.o(((...e)=>a.showAddCategoryModal&&a.showAddCategoryModal(...e))),g:e.f(a.categories,((o,t,r)=>({a:e.t(o.name),b:e.t(o.description||"暂无描述"),c:e.t(a.getCategoryProductCount(o.id)),d:e.o((e=>a.editCategory(o)),o.id),e:e.o((e=>a.deleteCategory(o)),o.id),f:o.id}))),h:0===a.categories.length},(a.categories.length,{})):{},{i:1===a.currentTab},1===a.currentTab?e.e({j:e.o(((...e)=>a.showAddProductModal&&a.showAddProductModal(...e))),k:e.f(a.products,((o,t,r)=>({a:a.getProductImageUrl(o),b:e.t(o.name),c:e.t(o.category_name||"未知分类"),d:e.t(o.price),e:e.o((e=>a.editProduct(o)),o.id),f:e.o((e=>a.deleteProduct(o)),o.id),g:o.id}))),l:0===a.products.length},(a.products.length,{})):{},{m:a.showCategoryModal},a.showCategoryModal?{n:e.t(a.categoryForm.id?"编辑分类":"添加分类"),o:e.o(((...e)=>a.closeCategoryModal&&a.closeCategoryModal(...e))),p:a.categoryForm.name,q:e.o((e=>a.categoryForm.name=e.detail.value)),r:a.categoryForm.description,s:e.o((e=>a.categoryForm.description=e.detail.value)),t:e.o(((...e)=>a.closeCategoryModal&&a.closeCategoryModal(...e))),v:e.o(((...e)=>a.saveCategoryModal&&a.saveCategoryModal(...e))),w:e.o((()=>{})),x:e.o(((...e)=>a.closeCategoryModal&&a.closeCategoryModal(...e)))}:{},{y:a.showProductModal},a.showProductModal?e.e({z:e.t(a.productForm.id?"编辑商品":"添加商品"),A:e.o(((...e)=>a.closeProductModal&&a.closeProductModal(...e))),B:a.productForm.name,C:e.o((e=>a.productForm.name=e.detail.value)),D:a.productForm.price,E:e.o((e=>a.productForm.price=e.detail.value)),F:e.t(a.categoryOptions[a.productForm.categoryIndex]||"请选择分类"),G:a.productForm.categoryIndex,H:a.categoryOptions,I:e.o(((...e)=>a.handleCategoryChange&&a.handleCategoryChange(...e))),J:a.productForm.description,K:e.o((e=>a.productForm.description=e.detail.value)),L:a.productForm.imageUrl},a.productForm.imageUrl?{M:a.productForm.imageUrl}:{},{N:e.o(((...e)=>a.chooseImage&&a.chooseImage(...e))),O:a.productForm.imageUrl},a.productForm.imageUrl?{P:e.o(((...e)=>a.removeImage&&a.removeImage(...e)))}:{},{Q:e.o(((...e)=>a.closeProductModal&&a.closeProductModal(...e))),R:e.o(((...e)=>a.saveProductModal&&a.saveProductModal(...e))),S:e.o((()=>{})),T:e.o(((...e)=>a.closeProductModal&&a.closeProductModal(...e)))}):{})}],["__scopeId","data-v-0aeea83b"]]);wx.createPage(c);
