"use strict";const e=require("../../common/vendor.js"),a=require("../../store/user.js"),o=require("../../mixins/theme.js");require("../../store/theme.js");const t=require("../../api/user.js"),s={setup(){const s=a.useUserStore(),{currentTheme:r,getThemeColor:n,getButtonStyle:i,getHeaderStyle:l}=o.useTheme(),u=e.ref(!1),c=e.ref({username:"",email:"",bio:""}),m=e.computed((()=>s.userInfo));e.onMounted((()=>{m.value&&(c.value={username:m.value.username||"",email:m.value.email||"",bio:m.value.bio||""})}));const v=()=>{e.index.navigateBack()};return{formData:c,saving:u,getUserAvatarUrl:()=>{var e;return(null==(e=m.value)?void 0:e.avatar_url)?m.value.avatar_url.startsWith("http")?m.value.avatar_url:`https://xcx.euans.xyz${m.value.avatar_url}`:"/static/images/default-avatar.png"},changeAvatar:()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async a=>{const o=a.tempFilePaths[0];console.log("选择的头像:",o),e.index.showLoading({title:"上传中..."});try{const a=await t.uploadAvatar(o);console.log("头像上传成功:",a),a.user&&(s.userInfo=a.user,s.saveUserToLocal()),e.index.hideLoading(),e.index.showToast({title:"头像更新成功",icon:"success"})}catch(r){console.error("头像上传失败:",r),e.index.hideLoading(),e.index.showToast({title:"头像上传失败: "+(r.message||"网络错误"),icon:"none"})}},fail:a=>{console.error("选择图片失败:",a),e.index.showToast({title:"选择图片失败",icon:"none"})}})},saveProfile:async()=>{if(!c.value.username.trim())return void e.index.showToast({title:"请输入用户名",icon:"none"});if(!c.value.email.trim())return void e.index.showToast({title:"请输入邮箱地址",icon:"none"});if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c.value.email)){u.value=!0;try{console.log("保存用户信息:",c.value);const a=await t.updateUserProfile(c.value);console.log("用户信息更新成功:",a),s.userInfo={...s.userInfo,...a},s.saveUserToLocal(),e.index.showToast({title:"保存成功",icon:"success"}),setTimeout((()=>{v()}),1500)}catch(a){console.error("保存失败:",a),e.index.showToast({title:"保存失败: "+(a.message||"网络错误"),icon:"none"})}finally{u.value=!1}}else e.index.showToast({title:"邮箱格式不正确",icon:"none"})},goBack:v,currentTheme:r,getThemeColor:n,getButtonStyle:i,getHeaderStyle:l}}};const r=e._export_sfc(s,[["render",function(a,o,t,s,r,n){return{a:s.getUserAvatarUrl(),b:e.o(((...e)=>s.changeAvatar&&s.changeAvatar(...e))),c:s.formData.username,d:e.o((e=>s.formData.username=e.detail.value)),e:s.formData.email,f:e.o((e=>s.formData.email=e.detail.value)),g:s.formData.bio,h:e.o((e=>s.formData.bio=e.detail.value)),i:e.t(s.formData.bio.length),j:e.t(s.saving?"保存中...":"保存修改"),k:e.o(((...e)=>s.saveProfile&&s.saveProfile(...e))),l:s.saving,m:e.o(((...e)=>s.goBack&&s.goBack(...e)))}}]]);wx.createPage(r);
