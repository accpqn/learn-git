"use strict";const e=require("../../common/vendor.js"),t=require("../../store/couple.js"),n=require("../../store/user.js"),a=require("../../mixins/theme.js"),s={setup(){const s=t.useCoupleStore(),i=n.useUserStore(),{currentTheme:o,getThemeColor:r,getButtonStyle:d,getHeaderStyle:u,getBadgeStyle:l}=a.useTheme(),c=e.ref(!1),g=e.ref(!1),m=e.ref({email:"",message:""}),f=e.computed((()=>s.bindingInfo)),v=e.computed((()=>s.pendingRequests||[])),y=e.computed((()=>s.bindingHistory||[])),h=e.computed((()=>i.userInfo)),q=e.computed((()=>{var e;if(!f.value||"active"!==f.value.status)return"";const t=null==(e=h.value)?void 0:e.id;return t?f.value.requester.id===t?f.value.receiver.username:f.value.requester.username:""})),b=e.computed((()=>{var e;if(!f.value||"active"!==f.value.status)return"";const t=null==(e=h.value)?void 0:e.id;return t?f.value.requester.id===t?f.value.receiver.email:f.value.requester.email:""}));e.onMounted((()=>{w()})),e.onShow((()=>{w()}));const w=async()=>{try{await Promise.all([s.fetchBindingInfo(),s.fetchPendingRequests(),s.fetchBindingHistory()])}catch(e){console.error("加载情侣数据失败:",e)}};return{showBindModal:c,showInfoModal:g,bindForm:m,bindingInfo:f,pendingRequests:v,bindingHistory:y,partnerName:q,partnerEmail:b,showBindDialog:()=>{m.value={email:"",message:""},c.value=!0},closeBindDialog:()=>{c.value=!1},sendBindRequest:async()=>{if(m.value.email)try{await s.sendBindingRequest(m.value.email,m.value.message)&&(e.index.showToast({title:"绑定请求已发送",icon:"success"}),c.value=!1,w())}catch(t){let n=t.message||"网络错误";n.includes("您已向该用户发起过绑定请求")?n="请等待对方回应，不要重复发送请求":n.includes("已经处于一个激活的绑定关系")?n="您或对方已有绑定关系":n.includes("该邮箱对应的用户不存在")&&(n="该邮箱用户不存在"),e.index.showToast({title:n,icon:"none",duration:3e3})}else e.index.showToast({title:"请输入对方邮箱",icon:"none"})},acceptRequest:async t=>{try{await s.acceptBindingRequest(t.id)&&(e.index.showToast({title:"已接受绑定请求",icon:"success"}),w())}catch(n){e.index.showToast({title:"操作失败: "+(n.message||"网络错误"),icon:"none"})}},rejectRequest:async t=>{e.index.showModal({title:"拒绝绑定",content:`确定要拒绝来自 ${t.requester.username} 的绑定请求吗？`,success:async n=>{if(n.confirm)try{await s.rejectBindingRequest(t.id)&&(e.index.showToast({title:"已拒绝绑定请求",icon:"success"}),w())}catch(a){e.index.showToast({title:"操作失败: "+(a.message||"网络错误"),icon:"none"})}}})},cancelRequest:async()=>{e.index.showModal({title:"取消请求",content:"确定要取消绑定请求吗？",success:async t=>{if(t.confirm)try{await s.cancelBindingRequest()&&(e.index.showToast({title:"已取消绑定请求",icon:"success"}),w())}catch(n){e.index.showToast({title:"操作失败: "+(n.message||"网络错误"),icon:"none"})}}})},confirmUnbind:()=>{e.index.showModal({title:"解除绑定",content:`确定要与 ${q.value} 解除绑定吗？\n\n解绑后：\n• 历史数据将保留\n• 可以重新绑定其他用户\n• 对方也会收到解绑通知`,success:async t=>{if(t.confirm)try{await s.unbind()&&(e.index.showToast({title:"已解除绑定",icon:"success"}),w())}catch(n){e.index.showToast({title:"操作失败: "+(n.message||"网络错误"),icon:"none"})}}})},showPartnerInfo:()=>{g.value=!0},formatDate:t=>e.dayjs(t).format("YYYY-MM-DD HH:mm"),formatDateRange:(t,n)=>`${e.dayjs(t).format("YYYY-MM-DD")} ~ ${n?e.dayjs(n).format("YYYY-MM-DD"):"至今"}`,getBindingDays:()=>{var t;return(null==(t=f.value)?void 0:t.created_at)?e.dayjs().diff(e.dayjs(f.value.created_at),"day"):0},getPartnerAvatar:()=>"/static/images/default-avatar.png",getRequesterAvatar:e=>"/static/images/default-avatar.png",getHistoryPartnerName:e=>{var t;const n=null==(t=h.value)?void 0:t.id;return e.requester.id===n?e.receiver.username:e.requester.username},getHistoryStatusText:e=>e.deleted_at||"unbound"===e.status?"已解绑":"active"===e.status?"已绑定":"requesting"===e.status?"等待回应":"rejected"===e.status?"已拒绝":"未知状态",getHistoryStatusClass:e=>e.deleted_at||"unbound"===e.status?"status-unbound":"active"===e.status?"status-active":"requesting"===e.status?"status-requesting":"rejected"===e.status?"status-rejected":"status-unknown",currentTheme:o,getThemeColor:r,getButtonStyle:d,getHeaderStyle:u,getBadgeStyle:l}}};const i=e._export_sfc(s,[["render",function(t,n,a,s,i,o){var r,d;return e.e({a:e.s(s.getHeaderStyle()),b:s.bindingInfo&&"active"===s.bindingInfo.status},s.bindingInfo&&"active"===s.bindingInfo.status?{c:s.getPartnerAvatar(),d:e.t(s.partnerName),e:e.t(s.partnerEmail),f:e.t(s.formatDate(s.bindingInfo.created_at)),g:e.s(s.getButtonStyle("outline")),h:e.o(((...e)=>s.showPartnerInfo&&s.showPartnerInfo(...e))),i:e.s(s.getButtonStyle("danger")),j:e.o(((...e)=>s.confirmUnbind&&s.confirmUnbind(...e)))}:s.bindingInfo&&"pending"===s.bindingInfo.status?{l:e.t((null==(r=s.bindingInfo.receiver)?void 0:r.email)||(null==(d=s.bindingInfo.requester)?void 0:d.email)),m:e.t(s.formatDate(s.bindingInfo.created_at)),n:e.s(s.getButtonStyle("outline")),o:e.o(((...e)=>s.cancelRequest&&s.cancelRequest(...e)))}:{p:e.s(s.getButtonStyle("primary")),q:e.o(((...e)=>s.showBindDialog&&s.showBindDialog(...e)))},{k:s.bindingInfo&&"pending"===s.bindingInfo.status,r:s.pendingRequests.length>0},s.pendingRequests.length>0?{s:e.t(s.pendingRequests.length),t:e.s(s.getBadgeStyle("count")),v:e.f(s.pendingRequests,((t,n,a)=>({a:s.getRequesterAvatar(t),b:e.t(t.requester.username),c:e.t(t.requester.email),d:e.t(s.formatDate(t.created_at)),e:e.o((e=>s.acceptRequest(t)),t.id),f:e.o((e=>s.rejectRequest(t)),t.id),g:t.id}))),w:e.s(s.getButtonStyle("primary")),x:e.s(s.getButtonStyle("outline"))}:{},{y:s.bindingHistory.length>0},s.bindingHistory.length>0?{z:e.f(s.bindingHistory,((t,n,a)=>({a:e.t(s.getHistoryPartnerName(t)),b:e.t(s.formatDateRange(t.created_at,t.deleted_at)),c:e.t(s.getHistoryStatusText(t)),d:e.n(s.getHistoryStatusClass(t)),e:t.id})))}:{},{A:s.showBindModal},s.showBindModal?{B:e.o(((...e)=>s.closeBindDialog&&s.closeBindDialog(...e))),C:s.bindForm.email,D:e.o((e=>s.bindForm.email=e.detail.value)),E:s.bindForm.message,F:e.o((e=>s.bindForm.message=e.detail.value)),G:e.o(((...e)=>s.closeBindDialog&&s.closeBindDialog(...e))),H:e.s(s.getButtonStyle("primary")),I:e.o(((...e)=>s.sendBindRequest&&s.sendBindRequest(...e))),J:e.o((()=>{})),K:e.o(((...e)=>s.closeBindDialog&&s.closeBindDialog(...e)))}:{},{L:s.showInfoModal},s.showInfoModal?e.e({M:e.o((e=>s.showInfoModal=!1)),N:s.bindingInfo},s.bindingInfo?{O:e.t(s.partnerName),P:e.t(s.partnerEmail),Q:e.t(s.formatDate(s.bindingInfo.created_at)),R:e.t(s.getBindingDays())}:{},{S:e.s(s.getButtonStyle("primary")),T:e.o((e=>s.showInfoModal=!1)),U:e.o((()=>{})),V:e.o((e=>s.showInfoModal=!1))}):{})}],["__scopeId","data-v-83b7cbe4"]]);wx.createPage(i);
