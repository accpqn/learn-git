"use strict";const e=require("../../common/vendor.js"),o=require("../../store/order.js"),t=require("../../store/user.js"),n=require("../../store/couple.js"),s=require("../../mixins/theme.js"),r=require("../../api/user.js"),a={setup(){const a=o.useOrderStore(),i=t.useUserStore(),l=n.useCoupleStore(),{currentTheme:u,getThemeColor:g,getButtonStyle:d,getHeaderStyle:c}=s.useTheme(),h=e.computed((()=>i.isLoggedIn)),v=e.computed((()=>i.userInfo)),m=e.computed((()=>l.bindingInfo)),p=e.computed((()=>{var e;if(!m.value||"active"!==m.value.status)return"";const o=null==(e=v.value)?void 0:e.id;return o?m.value.requester.id===o?m.value.receiver.username:m.value.requester.username:""})),f=e.computed((()=>({sent:a.sentOrders.length,received:a.receivedOrders.length,total:a.sentOrders.length+a.receivedOrders.length})));e.onMounted((()=>{console.log("User page onMounted - isLoggedIn:",i.isLoggedIn)})),e.onShow((()=>{console.log("User page onShow - isLoggedIn:",i.isLoggedIn),console.log("User page onShow - userInfo:",i.userInfo),console.log("User page onShow - token:",i.token),!i.isLoggedIn||i.userInfo&&i.userInfo.id||(console.log("Refreshing user info on page show"),i.fetchCurrentUser()),a.initOrders()})),e.watch((()=>i.isLoggedIn),((e,o)=>{console.log("Login status changed:",o,"->",e)}),{immediate:!0});const I=e.computed((()=>({color:u.value.primaryColor})));return{isLoggedIn:h,userInfo:v,bindingInfo:m,partnerName:p,orderStats:f,goToLogin:()=>{e.index.navigateTo({url:"/pages/public/login"})},getUserAvatarUrl:()=>{var e;return(null==(e=v.value)?void 0:e.avatar_url)?v.value.avatar_url.startsWith("http")?v.value.avatar_url:`https://xcx.euans.xyz${v.value.avatar_url}`:"/static/images/default-avatar.png"},changeAvatar:()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async o=>{const t=o.tempFilePaths[0];console.log("选择的头像文件:",t),e.index.showLoading({title:"上传中..."});try{const o=await r.uploadAvatar(t);console.log("头像上传成功:",o),o.user&&(i.userInfo=o.user,i.saveUserToLocal()),e.index.hideLoading(),e.index.showToast({title:"头像更新成功",icon:"success"})}catch(n){console.error("头像上传失败:",n),e.index.hideLoading(),e.index.showToast({title:"头像上传失败: "+(n.message||"网络错误"),icon:"none"})}},fail:o=>{console.error("选择图片失败:",o),e.index.showToast({title:"选择图片失败",icon:"none"})}})},editProfile:()=>{e.index.navigateTo({url:"/pages/user/profile"})},handleCoupleAction:()=>{e.index.navigateTo({url:"/pages/user/couple-manage"})},navigateToConfig:()=>{e.index.navigateTo({url:"/pages/settings/index"})},showAbout:()=>{e.index.showModal({title:"关于我们",content:"情侣点餐小程序 v1.0\n\n一个专为情侣设计的点餐应用，让爱情更有味道！",showCancel:!1})},clearData:()=>{e.index.showModal({title:"清除数据",content:"确定要清除所有本地数据吗？此操作不可恢复！",success:o=>{if(o.confirm)try{a.sentOrders=[],a.receivedOrders=[],a.saveOrdersToLocal(),e.index.clearStorageSync(),e.index.showToast({title:"数据已清除",icon:"success"})}catch(t){e.index.showToast({title:"清除失败",icon:"none"})}}})},handleLogout:()=>{e.index.showModal({title:"退出登录",content:"确定要退出登录吗？",success:o=>{o.confirm&&(i.logout(),l.setBindingInfo(null),e.index.showToast({title:"已退出登录",icon:"success"}))}})},currentTheme:u,getThemeColor:g,getButtonStyle:d,getHeaderStyle:c,statNumberStyle:I}}};const i=e._export_sfc(a,[["render",function(o,t,n,s,r,a){return e.e({a:!s.isLoggedIn},s.isLoggedIn?e.e({d:s.getUserAvatarUrl(),e:e.o(((...e)=>s.changeAvatar&&s.changeAvatar(...e))),f:e.t(s.userInfo.username||"用户"),g:e.t(s.userInfo.email),h:s.bindingInfo&&"active"===s.bindingInfo.status},s.bindingInfo&&"active"===s.bindingInfo.status?{i:e.t(s.partnerName)}:{},{j:e.s(s.getHeaderStyle()),k:e.t(s.orderStats.sent),l:e.s(s.statNumberStyle),m:e.t(s.orderStats.received),n:e.s(s.statNumberStyle),o:e.t(s.orderStats.total),p:e.s(s.statNumberStyle),q:e.o(((...e)=>s.editProfile&&s.editProfile(...e))),r:e.t(s.bindingInfo&&"active"===s.bindingInfo.status?"情侣管理":"绑定情侣"),s:e.o(((...e)=>s.handleCoupleAction&&s.handleCoupleAction(...e))),t:e.o(((...e)=>s.navigateToConfig&&s.navigateToConfig(...e))),v:e.o(((...e)=>s.showAbout&&s.showAbout(...e))),w:e.o(((...e)=>s.clearData&&s.clearData(...e))),x:e.s(s.getButtonStyle("outline")),y:e.o(((...e)=>s.handleLogout&&s.handleLogout(...e)))}):{b:e.s(s.getButtonStyle("primary")),c:e.o(((...e)=>s.goToLogin&&s.goToLogin(...e)))})}]]);wx.createPage(i);
