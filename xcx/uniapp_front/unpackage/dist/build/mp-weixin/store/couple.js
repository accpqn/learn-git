"use strict";const n=require("../common/vendor.js"),e=require("../api/core.js"),t=require("../api/user.js"),i=require("./user.js"),r=n.defineStore("couple",{state:()=>({bindingInfo:null,theme:{backgroundColor:"#FFFFFF",primaryColor:"#007AFF",backgroundImage:null},bindingRequestStatus:"idle",bindingRequestError:null,pendingRequests:[],bindingHistory:[]}),getters:{isBindingActive:n=>!!n.bindingInfo&&"active"===n.bindingInfo.status,partnerId:n=>{if(!n.bindingInfo)return null;const e=i.useUserStore(),{requester:t,receiver:r}=n.bindingInfo;return t.id===e.userId?r.id:t.id},partnerInfo:n=>{if(!n.bindingInfo)return null;const e=i.useUserStore(),{requester:t,receiver:r}=n.bindingInfo;return t.id===e.userId?r:t}},actions:{setBindingInfo(n){this.bindingInfo=n},setTheme(n){this.theme={...this.theme,...n}},async sendBindingRequest(n,e=""){this.bindingRequestStatus="pending",this.bindingRequestError=null;try{return await t.sendBindingRequest(n,e),this.bindingRequestStatus="success",!0}catch(i){throw this.bindingRequestStatus="error",this.bindingRequestError=i.message,i}},async respondToBinding(e,i){try{const n=await t.respondToBinding(e,i);return"accept"===i&&(this.bindingInfo=n),!0}catch(r){return n.index.showToast({title:r.message||"操作失败",icon:"none"}),!1}},async unbind(){if(!this.bindingInfo)return!1;try{return await t.unbind(this.bindingInfo.id),this.bindingInfo=null,!0}catch(e){return n.index.showToast({title:e.message||"解除绑定失败",icon:"none"}),!1}},async loadTheme(){try{const n=await e.themeApi.get();return this.setTheme(n),!0}catch(n){return console.error("Failed to load theme:",n),!1}},async updateTheme(t){try{return await e.themeApi.update(t),this.setTheme(t),!0}catch(i){return n.index.showToast({title:i.message||"更新主题失败",icon:"none"}),!1}},async fetchBindingInfo(){try{const n=await t.getBindingInfo();return this.bindingInfo=n,!0}catch(n){return console.error("获取绑定信息失败:",n),!1}},async fetchPendingRequests(){try{const n=await t.getPendingBindings();return this.pendingRequests=n,!0}catch(n){return console.error("获取待处理请求失败:",n),!1}},async fetchBindingHistory(){try{const n=await t.getBindingHistory();return this.bindingHistory=n,!0}catch(n){return console.error("获取绑定历史失败:",n),!1}},async acceptBindingRequest(n){try{const e=await t.respondToBinding(n,"accept");return this.bindingInfo=e,await this.fetchPendingRequests(),!0}catch(e){throw e}},async rejectBindingRequest(n){try{return await t.respondToBinding(n,"reject"),await this.fetchPendingRequests(),!0}catch(e){throw e}},async cancelBindingRequest(){try{return await t.cancelBindingRequest(),this.bindingInfo=null,!0}catch(n){throw n}}}});exports.useCoupleStore=r;
