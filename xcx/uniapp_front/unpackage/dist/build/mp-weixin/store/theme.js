"use strict";const e=require("../common/vendor.js"),r=require("../api/theme.js"),o=e.defineStore("theme",{state:()=>({currentTheme:{primaryColor:"#FF69B4",secondaryColor:"#FF1493",backgroundColor:"#FFF5F8",themeName:"粉色恋人"},presetThemes:r.presetThemes,loading:!1,initialized:!1}),getters:{cssVariables:e=>({"--theme-primary":e.currentTheme.primaryColor,"--theme-secondary":e.currentTheme.secondaryColor,"--theme-background":e.currentTheme.backgroundColor,"--theme-primary-light":e.currentTheme.primaryColor+"20","--theme-secondary-light":e.currentTheme.secondaryColor+"20"}),currentThemeName:e=>{const r=e.presetThemes.find((r=>r.primaryColor===e.currentTheme.primaryColor&&r.secondaryColor===e.currentTheme.secondaryColor&&r.backgroundColor===e.currentTheme.backgroundColor));return r?r.name:e.currentTheme.themeName||"自定义主题"},isPresetTheme:e=>e.presetThemes.some((r=>r.primaryColor===e.currentTheme.primaryColor&&r.secondaryColor===e.currentTheme.secondaryColor&&r.backgroundColor===e.currentTheme.backgroundColor))},actions:{async initTheme(){if(!this.initialized)try{const e=this.loadFromStorage();e&&(this.currentTheme={...e},this.applyTheme()),this.isLoggedIn()&&await this.fetchThemeFromServer(),this.setupLoginListener(),this.initialized=!0}catch(e){console.error("初始化主题失败:",e),this.currentTheme={...r.presetThemes[0]},this.applyTheme(),this.initialized=!0}},setupLoginListener(){e.index.$on("userLoginSuccess",(async e=>{console.log("收到用户登录成功事件，开始同步主题配置");try{await this.fetchThemeFromServer(),console.log("登录后主题配置同步成功")}catch(r){console.warn("登录后主题配置同步失败:",r)}}))},async fetchThemeFromServer(){if(this.isLoggedIn()){this.loading=!0;try{const e=await r.getThemeConfig();e&&(this.currentTheme={primaryColor:e.primary_color||e.primaryColor,secondaryColor:e.secondary_color||e.secondaryColor,backgroundColor:e.background_color||e.backgroundColor,themeName:e.theme_name||e.themeName||this.currentThemeName},this.applyTheme(),this.saveToStorage())}catch(e){console.error("获取服务器主题配置失败:",e),e.message&&e.message.includes("401")?console.log("认证失败，使用本地主题配置"):e.message&&(e.message.includes("没有激活的绑定关系")||e.message.includes("403"))?(console.log("新用户没有绑定关系，使用默认主题"),this.applyTheme()):(console.log("其他错误，使用本地主题配置"),this.applyTheme())}finally{this.loading=!1}}else console.log("用户未登录，跳过服务器主题获取")},async saveThemeToServer(){if(this.isLoggedIn()){this.loading=!0;try{const e={primary_color:this.currentTheme.primaryColor,secondary_color:this.currentTheme.secondaryColor,background_color:this.currentTheme.backgroundColor,theme_name:this.currentTheme.themeName||this.currentThemeName};await r.saveThemeConfig(e),this.saveToStorage(),console.log("主题配置已保存到服务器")}catch(e){throw console.error("保存主题配置到服务器失败:",e),this.saveToStorage(),e}finally{this.loading=!1}}else this.saveToStorage()},applyPresetTheme(e){this.currentTheme={primaryColor:e.primaryColor,secondaryColor:e.secondaryColor,backgroundColor:e.backgroundColor,themeName:e.name},this.applyTheme(),this.saveToStorage()},updateThemeColor(e,r){"primary"===e?this.currentTheme.primaryColor=r:"secondary"===e?this.currentTheme.secondaryColor=r:"background"===e&&(this.currentTheme.backgroundColor=r),this.isPresetTheme||(this.currentTheme.themeName="自定义主题"),this.applyTheme(),this.saveToStorage()},applyTheme(){try{this._applyThemeTimer&&clearTimeout(this._applyThemeTimer),this._applyThemeTimer=setTimeout((()=>{e.index.$emit("themeChanged",this.currentTheme),console.log("主题已应用:",this.currentTheme)}),50)}catch(r){console.error("应用主题失败:",r)}},saveToStorage(){try{e.index.setStorageSync("themeConfig",this.currentTheme)}catch(r){console.error("保存主题到本地存储失败:",r)}},loadFromStorage(){try{return e.index.getStorageSync("themeConfig")||null}catch(r){return console.error("从本地存储加载主题失败:",r),null}},isLoggedIn(){try{return!!e.index.getStorageSync("token")}catch(r){return!1}},resetToDefault(){this.currentTheme={...r.presetThemes[0]},this.applyTheme(),this.saveToStorage()}}});exports.useThemeStore=o;
