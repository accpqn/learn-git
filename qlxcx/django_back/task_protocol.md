# Context
Filename: task_protocol.md
Created On: 2024-07-26
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
用户希望创建一个点餐小程序。
- 前端小程序使用lin-ui框架。
- 后台管理系统使用Vue3。
- pyhton后端使用django。
- MySQL8.0数据库。
- 一个用户可以和另一个用户绑定，其中一个用户的点单信息发送给另一个用户，主要是针对情侣。
- 构思其他相关功能。

# Project Overview
一个为情侣设计的点餐小程序。后端使用Django，前端包含一个微信小程序和一个后台管理系统。核心功能是用户绑定和订单信息共享。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- **核心差异点识别**:
  - **菜单私有化**: 当前的 `MenuCategory` 和 `Product` 是全局的，而新需求要求每对情侣拥有自己独立的、可自定义的菜单和商品。这是最大的架构性差异。
  - **订单项备注**: 当前 `DemandOrderItem` 缺乏一个字段，让接收方能够对订单中的每一项商品进行单独备注（例如，实际花费金额、购买情况说明）。
  - **评价系统**: 系统目前完全没有订单完成后的评价/打分机制。
  - **个性化主题**: 系统缺少用于存储情侣共享空间个性化设置（如背景图片、主题色）的模型。
- **现有功能评估**:
  - `CoupleBinding` 模型能够很好地支持用户间的一对一绑定关系。
  - `DemandOrder` 的基本流程（创建、关联绑定关系、状态流转）可作为新需求的基础，但其 `status` 字段可能需要扩展以包含"已完成"、"待评价"等新状态。
  - API 权限控制（如用户只能看自己的订单）的逻辑是正确的，可以在新功能中复用。

# Proposed Solution (Populated by INNOVATE mode)
- **核心模型改造**:
  - **MenuCategory**: 添加一个指向 `CoupleBinding` 的外键，实现菜单与情侣的绑定。`Product` 通过 `MenuCategory` 间接实现归属。
  - **DemandOrderItem**: 直接在模型中添加 `receiver_notes` (TextField) 和 `actual_price` (DecimalField) 字段，允许为空，用于接收方填写备注和实际价格。
  - **DemandOrder**: 扩展 `OrderStatus` 枚举，增加 `COMPLETED` (已完成) 和 `RATED` (已评价) 状态。
- **新增独立模块**:
  - **OrderReview 模型**: 创建一个新模型用于订单评价，包含与 `DemandOrder` 的一对一关联、评分、评论内容和创建者信息。
  - **CoupleTheme 模型**: 创建一个新模型用于个性化主题，包含与 `CoupleBinding` 的一对一关联、背景图片和主题颜色等字段。
- **方案优势**:
  - 通过改造和新增模型，系统地满足了所有新需求。
  - 数据结构清晰，将不同功能模块解耦，易于维护。
  - 为未来的功能扩展（如评价统计、更多自定义选项）奠定了良好的基础。

# Implementation Plan (Generated by PLAN mode)
Implementation Checklist:
**Phase 1: Project Foundation & User Management**
1.  **环境配置**: 在 `djangoProject/settings.py` 中，修改 `LANGUAGE_CODE` 为 `'zh-Hans'`，`TIME_ZONE` 为 `'Asia/Shanghai'`。
2.  **数据库配置**: 在 `djangoProject/settings.py` 中，配置 `DATABASES` 以连接到 MySQL 8.0 数据库（将使用占位符填写敏感信息）。
3.  **依赖管理**: 创建 `requirements.txt` 文件，并添加 `django`, `djangorestframework`, `mysqlclient`, `djangorestframework-simplejwt`。
4.  **安装依赖**: (系统将提示您在终端执行) `pip install -r requirements.txt`。
5.  **创建应用**: (系统将提示您在终端执行) `python manage.py startapp users` 和 `python manage.py startapp core`。
6.  **注册应用与框架**: 在 `djangoProject/settings.py` 的 `INSTALLED_APPS` 列表中，添加 `'rest_framework'`, `'rest_framework_simplejwt'`, `'users'`, `'core'`。
7.  **配置认证后端**: 在 `djangoProject/settings.py` 中，配置 `REST_FRAMEWORK` 以使用 JWT 进行认证。
8.  **自定义用户模型**: 在 `users/models.py` 中创建 `User` 模型，继承自 `AbstractUser`，并添加小程序需要的字段（如 `openid`, `avatar_url`）。
9.  **配置用户模型**: 在 `djangoProject/settings.py` 中，设置 `AUTH_USER_MODEL = 'users.User'`。
10. **情侣绑定模型**: 在 `users/models.py` 中，创建 `CoupleBinding` 模型，包含 `user1`, `user2`, `status`, `binding_token` 等字段。
11. **序列化器**: 创建 `users/serializers.py` 文件，并编写 `UserSerializer` 和 `CoupleBindingSerializer`。
12. **视图逻辑**: 创建 `users/views.py`，实现用户注册、登录、资料管理及情侣绑定（发起、接受、解绑）的 API 视图。
13. **路由配置**: 创建 `users/urls.py` 并配置相关 API 的路由，然后在 `djangoProject/urls.py` 中包含它。
14. **数据库迁移脚本**: (系统将提示您在终端执行) `python manage.py makemigrations`。
15. **应用数据库迁移**: (系统将提示您在终端执行) `python manage.py migrate`。

**Phase 2 (revised v2): Role-Based Web Administration**
1.  **编写数据迁移**: 我将创建一个新的迁移文件 `users/migrations/0002_populate_groups.py`，并在其中编写代码来自动创建"内容管理员"用户组、分配权限，并创建演示用的"管理员"和"普通用户"账户。
2.  **配置 Admin 界面**: 我将修改 `users/admin.py` 文件，用详尽的中文注释注册 `User` 和 `CoupleBinding` 模型，并为它们定制后台显示选项。
3.  **执行数据库迁移**: (系统将提示您在终端执行) `python manage.py migrate`，以应用上述数据迁移。
4.  **创建超级管理员**: (系统将提示您在终端执行) `python manage.py createsuperuser`，您需要根据提示输入用户名和密码。
5.  **启动开发服务器**: (系统将提示您在终端执行) `python manage.py runserver`。
6.  **用户手动验证**:
    *   **验证超级管理员**: 在浏览器中打开 `http://127.0.0.1:8000/admin/`，使用您刚创建的**超级管理员**账户登录，确认您可以看到并管理所有内容（包括用户、用户组、情侣绑定等）。
    *   **验证管理员**: 退出后，使用演示的**管理员**账户（用户名: `admin_demo`, 密码: `complexpassword123`）登录，确认您**只能**看到"用户"和"情侣绑定"模块，且对用户只有查看权限。
    *   **验证普通用户**: 退出后，尝试使用演示的**普通用户**账户（用户名: `user_demo`, 密码: `complexpassword123`）登录，确认**登录失败**，并提示"该账户没有权限访问此网站"。

**Phase 3: Core Meal Ordering Logic**
1.  **创建核心模型**: 在 `core/models.py` 文件中，添加 `MenuCategory`（菜单分类）、`Product`（商品）、`DemandOrder`（需求订单）和 `DemandOrderItem`（需求订单项）的模型定义。
2.  **配置核心Admin界面**: 在 `core/admin.py` 文件中，注册新的核心模型，并为它们配置合适的后台显示和筛选选项。
3.  **依赖与迁移**: 为 `ImageField` 添加 `Pillow` 依赖，并为 `core` 应用的新模型生成并应用迁移文件。
4.  **创建核心序列化器**: 在 `core/serializers.py` 文件中，为核心模型创建序列化器，并为 `User` 模型创建一个简化的 `UserSimpleSerializer`。
5.  **实现核心视图逻辑**: 在 `core/views.py` 文件中，创建 `ViewSet` 来处理菜单、商品和需求订单的CRUD操作，并为 `User` 模型添加 `bindings` 属性以简化查询。
6.  **配置核心路由**: 在 `core/urls.py` 文件中为新的 `ViewSet` 配置路由，并将其包含到主 `djangoProject/urls.py` 文件中，同时优化用户API的URL结构。

**第四阶段：情侣中心功能 (Phase 4: Couple-Centric Features)**

**A部分：数据模型演进 (Part A: Data Model Evolution)**

1.  **改造 `MenuCategory` 模型**: 在 `core/models.py` 文件中，为 `MenuCategory` 模型增加一个指向 `users.models.CoupleBinding` 的外键 `binding`，使其与情侣绑定关系关联。
2.  **扩展 `DemandOrder` 状态**: 在 `core/models.py` 文件中，修改 `DemandOrder` 模型内的 `OrderStatus` 枚举，新增 `'COMPLETED'` (已完成) 和 `'RATED'` (已评价) 两个状态。
3.  **增强 `DemandOrderItem` 模型**: 在 `core/models.py` 文件中，为 `DemandOrderItem` 模型增加两个可为空的字段：`receiver_notes` (文本类型) 和 `actual_price` (十进制数字类型)。
4.  **创建 `OrderReview` 模型**: 在 `core/models.py` 文件中，新增 `OrderReview` 模型，包含指向 `DemandOrder` 的一对一字段 `order`、评分 `rating`、评论 `comment`、创建者 `creator` 以及时间戳。
5.  **创建 `CoupleTheme` 模型**: 在 `core/models.py` 文件中，新增 `CoupleTheme` 模型，包含指向 `CoupleBinding` 的一对一字段 `binding`、背景图 `background_image`、主题颜色 `theme_color` 以及时间戳。
6.  **生成数据库迁移脚本**: (执行) `python manage.py makemigrations core` 命令，为 `core` 应用的所有模型变更创建迁移文件。

**B部分：后端逻辑与API实现 (Part B: Backend Logic & API Implementation)**

7.  **更新 Admin 后台**: 在 `core/admin.py` 文件中，更新已修改模型的后台配置，并注册所有新创建的模型 (`OrderReview`, `CoupleTheme`)。
8.  **更新核心序列化器**: 在 `core/serializers.py` 文件中，调整 `MenuCategorySerializer` 和 `ProductSerializer` 以支持新的数据归属逻辑。
9.  **更新订单序列化器**: 在 `core/serializers.py` 文件中，修改 `DemandOrderItemSerializer` 以包含新增的备注和实际价格字段，并考虑为接收方创建专门的更新序列化器。
10. **创建新的序列化器**: 在 `core/serializers.py` 文件中，为 `OrderReview` 和 `CoupleTheme` 两个新模型创建对应的序列化器。
11. **更新核心视图集**: 在 `core/views.py` 文件中，修改 `MenuCategoryViewSet` 和 `ProductViewSet` 的查询逻辑和创建逻辑，以强制实现数据的情侣隔离。
12. **创建新的视图集**: 在 `core/views.py` 文件中，为 `OrderReview` 和 `CoupleTheme` 创建新的 `ViewSet`，并配置相应的操作权限。
13. **配置API路由**: 在 `core/urls.py` 文件中，注册新增的视图集，以暴露评价和主题功能的 API 端点。

**C部分：最终化 (Part C: Finalization)**

14. **应用数据库迁移**: (执行) `python manage.py migrate` 命令，将所有数据库结构变更应用到数据库中。

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "Phase 4 Completed"

# Task Progress (Appended by EXECUTE mode after each step completion)
*   [2024-07-26]
    *   Step: 1. 环境配置
    *   Modifications: `djangoProject/settings.py` (LANGUAGE_CODE, TIME_ZONE)
    *   Change Summary: 将项目语言时区本地化。
    *   Reason: 执行计划步骤 1
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 2. 数据库配置
    *   Modifications: `djangoProject/settings.py` (DATABASES)
    *   Change Summary: 配置数据库连接为 MySQL。
    *   Reason: 执行计划步骤 2
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 3. 依赖管理
    *   Modifications: `requirements.txt` (创建)
    *   Change Summary: 添加项目所需依赖库。
    *   Reason: 执行计划步骤 3
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 4. 安装依赖
    *   Modifications: (无文件修改)
    *   Change Summary: 通过 pip 安装了所有依赖。
    *   Reason: 执行计划步骤 4
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 5. 创建应用
    *   Modifications: `users/`, `core/` (创建目录和文件)
    *   Change Summary: 创建了 users 和 core 应用。
    *   Reason: 执行计划步骤 5
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 6. 注册应用与框架
    *   Modifications: `djangoProject/settings.py` (INSTALLED_APPS)
    *   Change Summary: 注册了新应用和框架。
    *   Reason: 执行计划步骤 6
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 7. 配置认证后端
    *   Modifications: `djangoProject/settings.py` (REST_FRAMEWORK)
    *   Change Summary: 配置 DRF 使用 JWT 认证。
    *   Reason: 执行计划步骤 7
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 8. 自定义用户模型
    *   Modifications: `users/models.py`
    *   Change Summary: 创建了自定义 User 模型。
    *   Reason: 执行计划步骤 8
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 9. 配置用户模型
    *   Modifications: `djangoProject/settings.py` (AUTH_USER_MODEL)
    *   Change Summary: 配置 Django 使用自定义用户模型。
    *   Reason: 执行计划步骤 9
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 10. 情侣绑定模型
    *   Modifications: `users/models.py`
    *   Change Summary: 创建了 CoupleBinding 模型。
    *   Reason: 执行计划步骤 10
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 11. 序列化器
    *   Modifications: `users/serializers.py` (创建)
    *   Change Summary: 创建了 User 和 CoupleBinding 序列化器。
    *   Reason: 执行计划步骤 11
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 12. 视图逻辑
    *   Modifications: `users/views.py`
    *   Change Summary: 实现了用户和绑定管理的 API 视图。
    *   Reason: 执行计划步骤 12
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 13. 路由配置
    *   Modifications: `users/urls.py` (创建), `djangoProject/urls.py`
    *   Change Summary: 配置了用户和认证的 API 路由。
    *   Reason: 执行计划步骤 13
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 14. 数据库迁移脚本
    *   Modifications: `users/migrations/0001_initial.py` (创建)
    *   Change Summary: 生成了数据库迁移文件。
    *   Reason: 执行计划步骤 14
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2024-07-26]
    *   Step: 15. 应用数据库迁移
    *   Modifications: (无文件修改)
    *   Change Summary: 成功将模型应用到数据库。
    *   Reason: 执行计划步骤 15
    *   Blockers: None
    *   User Confirmation Status: Success
*   [2025-06-18]
    *   Step: Phase 3, Steps 1-6: Core Meal Ordering Logic Implementation
    *   Modifications: 
        - `core/models.py`: Created MenuCategory, Product, DemandOrder, DemandOrderItem models.
        - `core/admin.py`: Registered core models for Django Admin.
        - `requirements.txt`: Added Pillow dependency.
        - `core/migrations/0001_initial.py`: Generated database migration.
        - `users/serializers.py`: Added UserSimpleSerializer.
        - `core/serializers.py`: Created serializers for core models.
        - `users/models.py`: Added `bindings` property to User model.
        - `core/views.py`: Implemented ViewSets for core models with permissions.
        - `core/urls.py`: Created URL routes for core API.
        - `djangoProject/urls.py`: Included core API routes.
        - `users/urls.py`: Corrected user API URL structure.
    *   Change Summary: 成功完成了核心点餐功能的后端开发，包括模型、后台、序列化器、视图和路由的完整实现。
    *   Reason: 执行计划第三阶段
    *   Blockers: Encountered and resolved several `edit_file` tool failures.
    *   User Confirmation Status: Pending Confirmation
*   [2024-07-26]
    *   Step: Phase 4, Steps 1-14: Couple-Centric Features
    *   Modifications:
        - `core/models.py`: Modified models to be couple-centric, added review and theme models.
        - `core/migrations/0002_...`: Generated and applied database migration for new features.
        - `core/admin.py`: Updated admin panels for all new and modified models.
        - `core/serializers.py`: Overhauled serializers to support new logic, validation, and models.
        - `core/views.py`: Refactored views for data isolation and added new viewsets for reviews, themes, etc.
        - `core/urls.py`: Configured standard, nested, and singleton routes for all new API endpoints.
    *   Change Summary: 成功实现了所有情侣中心的功能，包括私有化菜单、订单备注、评价系统和个性化主题。
    *   Reason: 执行计划第四阶段
    *   Blockers: The initial `makemigrations` command failed due to a non-nullable field, which was resolved by adjusting the model and re-running the command.
    *   User Confirmation Status: Pending Confirmation

# Final Review (Populated by REVIEW mode)
[Summary of implementation compliance assessment against the final plan, whether unreported deviations were found] 