"use strict";const e=require("../../common/vendor.js"),o=require("../../store/order.js"),n=require("../../store/user.js"),t=require("../../store/couple.js");var s={VITE_CJS_IGNORE_WARNING:"true",VITE_ROOT_DIR:"D:/Python/python_doc/xcx/uniapp_front",VITE_USER_NODE_ENV:"production",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const a={setup(){const a=o.useOrderStore(),i=n.useUserStore(),r=t.useCoupleStore(),c=e.computed((()=>i.isLoggedIn)),d=e.computed((()=>i.userInfo)),l=e.computed((()=>r.bindingInfo)),u=e.computed((()=>{var e;if(!l.value||"active"!==l.value.status)return"";const o=null==(e=d.value)?void 0:e.id;return o?l.value.requester.id===o?l.value.receiver.username:l.value.requester.username:""})),g=e.computed((()=>({sent:a.sentOrders.length,received:a.receivedOrders.length,total:a.sentOrders.length+a.receivedOrders.length})));e.onMounted((()=>{console.log("User page onMounted - isLoggedIn:",i.isLoggedIn)})),e.onShow((()=>{console.log("User page onShow - isLoggedIn:",i.isLoggedIn),console.log("User page onShow - userInfo:",i.userInfo),console.log("User page onShow - token:",i.token),!i.isLoggedIn||i.userInfo&&i.userInfo.id||(console.log("Refreshing user info on page show"),i.fetchCurrentUser()),a.initOrders()})),e.watch((()=>i.isLoggedIn),((e,o)=>{console.log("Login status changed:",o,"->",e)}),{immediate:!0});return{isLoggedIn:c,userInfo:d,bindingInfo:l,partnerName:u,orderStats:g,goToLogin:()=>{e.index.navigateTo({url:"/pages/public/login"})},getUserAvatarUrl:()=>{var e;return(null==(e=d.value)?void 0:e.avatar_url)?d.value.avatar_url.startsWith("http")?d.value.avatar_url:`${s.VITE_API_BASE_URL||"http://127.0.0.1:8000"}${d.value.avatar_url}`:"/static/images/default-avatar.png"},changeAvatar:()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async o=>{const n=o.tempFilePaths[0];console.log("选择的头像文件:",n),e.index.showLoading({title:"上传中..."});try{const{uploadAvatar:o}=await"../../api/user.js",t=await o(n);console.log("头像上传成功:",t),t.user&&(i.userInfo=t.user,i.saveUserToLocal()),e.index.hideLoading(),e.index.showToast({title:"头像更新成功",icon:"success"})}catch(t){console.error("头像上传失败:",t),e.index.hideLoading(),e.index.showToast({title:"头像上传失败: "+(t.message||"网络错误"),icon:"none"})}},fail:o=>{console.error("选择图片失败:",o),e.index.showToast({title:"选择图片失败",icon:"none"})}})},editProfile:()=>{e.index.navigateTo({url:"/pages/user/profile"})},handleCoupleAction:()=>{l.value&&"active"===l.value.status?e.index.showModal({title:"情侣管理",content:`您已与${u.value}绑定，是否要解除绑定？`,success:async o=>{if(o.confirm)try{await r.unbind()&&e.index.showToast({title:"已解除绑定",icon:"success"})}catch(n){e.index.showToast({title:"解绑失败",icon:"none"})}}}):e.index.showModal({title:"绑定情侣",content:"请输入对方的邮箱地址",editable:!0,placeholderText:"输入对方邮箱",success:async o=>{if(o.confirm&&o.content)try{await r.sendBindingRequest(o.content)&&e.index.showToast({title:"绑定请求已发送",icon:"success"})}catch(n){e.index.showToast({title:"发送失败",icon:"none"})}}})},navigateToTheme:()=>{e.index.showToast({title:"主题设置功能开发中...",icon:"none"})},navigateToConfig:()=>{e.index.navigateTo({url:"/pages/settings/index"})},showAbout:()=>{e.index.showModal({title:"关于我们",content:"情侣点餐小程序 v1.0\n\n一个专为情侣设计的点餐应用，让爱情更有味道！",showCancel:!1})},clearData:()=>{e.index.showModal({title:"清除数据",content:"确定要清除所有本地数据吗？此操作不可恢复！",success:o=>{if(o.confirm)try{a.sentOrders=[],a.receivedOrders=[],a.saveOrdersToLocal(),e.index.clearStorageSync(),e.index.showToast({title:"数据已清除",icon:"success"})}catch(n){e.index.showToast({title:"清除失败",icon:"none"})}}})},handleLogout:()=>{e.index.showModal({title:"退出登录",content:"确定要退出登录吗？",success:o=>{o.confirm&&(i.logout(),r.setBindingInfo(null),e.index.showToast({title:"已退出登录",icon:"success"}))}})}}}};const i=e._export_sfc(a,[["render",function(o,n,t,s,a,i){return e.e({a:!s.isLoggedIn},s.isLoggedIn?e.e({c:s.getUserAvatarUrl(),d:e.o(((...e)=>s.changeAvatar&&s.changeAvatar(...e))),e:e.t(s.userInfo.username||"用户"),f:e.t(s.userInfo.email),g:s.bindingInfo&&"active"===s.bindingInfo.status},s.bindingInfo&&"active"===s.bindingInfo.status?{h:e.t(s.partnerName)}:{},{i:e.t(s.orderStats.sent),j:e.t(s.orderStats.received),k:e.t(s.orderStats.total),l:e.o(((...e)=>s.editProfile&&s.editProfile(...e))),m:e.t(s.bindingInfo&&"active"===s.bindingInfo.status?"情侣管理":"绑定情侣"),n:e.o(((...e)=>s.handleCoupleAction&&s.handleCoupleAction(...e))),o:e.o(((...e)=>s.navigateToTheme&&s.navigateToTheme(...e))),p:e.o(((...e)=>s.navigateToConfig&&s.navigateToConfig(...e))),q:e.o(((...e)=>s.showAbout&&s.showAbout(...e))),r:e.o(((...e)=>s.clearData&&s.clearData(...e))),s:e.o(((...e)=>s.handleLogout&&s.handleLogout(...e)))}):{b:e.o(((...e)=>s.goToLogin&&s.goToLogin(...e)))})}]]);wx.createPage(i);
