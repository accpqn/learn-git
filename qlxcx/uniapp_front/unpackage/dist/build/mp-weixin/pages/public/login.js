"use strict";const o=require("../../common/vendor.js"),e=require("../../utils/config.js"),s=require("../../store/user.js"),i=require("../../store/couple.js"),t={components:{AppIntro:()=>"../../components/public/AppIntro.js",AgreementLinks:()=>"../../components/public/AgreementLinks.js"},setup:()=>({userStore:s.useUserStore(),coupleStore:i.useCoupleStore()}),data:()=>({loginMode:"password",form:{email:"",password:"",code:""},countdown:0,registerUrl:e.APP_CONFIG.pages.register}),computed:{isEmailValid(){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.form.email)},isFormValid(){return"password"===this.loginMode?this.form.email&&this.form.password:this.form.email&&this.form.code}},methods:{switchLoginMode(o){this.loginMode=o,this.form.password="",this.form.code=""},async handleLogin(){if(this.isFormValid){o.index.showLoading({title:"登录中...",mask:!0});try{let e=!1;if(e="password"===this.loginMode?await this.userStore.login({email:this.form.email,password:this.form.password}):await this.userStore.loginWithCode({email:this.form.email,code:this.form.code}),!e)throw new Error("登录失败");console.log("Login success - userStore state:",{isLoggedIn:this.userStore.isLoggedIn,userInfo:this.userStore.userInfo,token:this.userStore.token}),o.index.hideLoading(),o.index.showToast({title:"登录成功！",icon:"success",duration:1500}),setTimeout((()=>{o.index.switchTab({url:"/pages/home/index"})}),1500)}catch(e){o.index.hideLoading(),o.index.showToast({title:e.message||"登录失败，请检查账号密码",icon:"none",duration:2e3})}}},async handleSendCode(){if(this.isEmailValid)try{await this.userStore.sendVerificationCode(this.form.email),this.countdown=60;const e=setInterval((()=>{this.countdown--,this.countdown<=0&&clearInterval(e)}),1e3);o.index.showToast({title:"验证码已发送",icon:"success"})}catch(e){o.index.showToast({title:e.message||"发送验证码失败",icon:"none"})}else o.index.showToast({title:"请输入有效的邮箱地址",icon:"none"})}}};const n=o._export_sfc(t,[["render",function(e,s,i,t,n,r){return o.e({a:o.n({active:"password"===n.loginMode}),b:o.o((o=>r.switchLoginMode("password"))),c:o.n({active:"code"===n.loginMode}),d:o.o((o=>r.switchLoginMode("code"))),e:n.form.email,f:o.o((o=>n.form.email=o.detail.value)),g:"password"===n.loginMode},"password"===n.loginMode?{h:n.form.password,i:o.o((o=>n.form.password=o.detail.value))}:{},{j:"code"===n.loginMode},"code"===n.loginMode?{k:n.form.code,l:o.o((o=>n.form.code=o.detail.value)),m:o.t(n.countdown>0?`${n.countdown}s`:"获取验证码"),n:!r.isEmailValid||n.countdown>0?1:"",o:!r.isEmailValid||n.countdown>0,p:o.o(((...o)=>r.handleSendCode&&r.handleSendCode(...o)))}:{},{q:o.t("password"===n.loginMode?"立即登录":"验证登录"),r:r.isFormValid?"":1,s:!r.isFormValid,t:o.o(((...o)=>r.handleLogin&&r.handleLogin(...o))),v:n.registerUrl})}]]);wx.createPage(n);
