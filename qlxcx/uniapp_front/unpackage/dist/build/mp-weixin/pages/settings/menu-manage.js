"use strict";const e=require("../../common/vendor.js"),o=require("../../api/menu.js"),t=require("../../config/index.js"),r={name:"MenuManage",setup(){const r=e.ref([]),a=e.ref([]),c=e.ref(!1),i=e.ref(0),d=e.ref(!1),l=e.reactive({id:null,name:"",description:""}),s=e.ref(!1),n=e.reactive({id:null,name:"",price:"",category:null,categoryIndex:0,description:"",imageUrl:"",imageFile:null}),g=e.computed((()=>r.value.map((e=>e.name))));e.onMounted((()=>{u()}));const u=async()=>{c.value=!0;try{await Promise.all([m(),y()])}catch(o){console.error("加载数据失败:",o),e.index.showToast({title:"加载数据失败",icon:"error"})}finally{c.value=!1}},m=async()=>{try{const e=await o.getCategories();r.value=e.sort(((e,o)=>(e.sort_order||0)-(o.sort_order||0)))}catch(e){console.error("加载分类失败:",e)}},y=async()=>{try{const e=await o.getProducts();a.value=e.sort(((e,o)=>(e.sort_order||0)-(o.sort_order||0)))}catch(e){console.error("加载商品失败:",e)}},p=t.getProductImageUrl,h=e=>a.value.filter((o=>o.category===e)).length,w=()=>{l.id=null,l.name="",l.description=""},v=()=>{n.id=null,n.name="",n.price="",n.category=r.value.length>0?r.value[0].id:null,n.categoryIndex=0,n.description="",n.imageUrl="",n.imageFile=null},P=(o,r,a,c)=>new Promise(((i,d)=>{const l=c?`${t.config.API_BASE_URL}/api/menus/products/${o}/`:`${t.config.API_BASE_URL}/api/menus/products/`,s=e.index.getStorageSync("token");e.index.uploadFile({url:l,filePath:a,name:"image",formData:{...r,_method:c?"PUT":"POST"},header:{Authorization:`Bearer ${s}`},success:e=>{console.log("上传成功:",e),200===e.statusCode||201===e.statusCode?i(JSON.parse(e.data)):d(new Error(`上传失败: ${e.statusCode}`))},fail:e=>{console.error("上传失败:",e),d(e)}})}));return{categories:r,products:a,loading:c,currentTab:i,showCategoryModal:d,categoryForm:l,showProductModal:s,productForm:n,categoryOptions:g,loadData:u,switchTab:e=>{i.value=e},getProductImageUrl:p,getCategoryProductCount:h,getCategoryName:e=>{const o=r.value.find((o=>o.id===e));return o?o.name:"未知分类"},showAddCategoryModal:()=>{console.log("显示添加分类弹窗"),w(),d.value=!0},editCategory:e=>{l.id=e.id,l.name=e.name,l.description=e.description||"",d.value=!0},saveCategoryModal:async()=>{if(console.log("保存分类开始",l),l.name.trim())try{const t={name:l.name.trim(),description:l.description.trim()};if(console.log("准备发送的数据:",t),l.id)console.log("编辑分类:",l.id),await o.updateCategory(l.id,t),e.index.showToast({title:"分类更新成功",icon:"success"});else{console.log("新增分类");const r=await o.addCategory(t);console.log("新增分类结果:",r),e.index.showToast({title:"分类添加成功",icon:"success"})}d.value=!1,await m()}catch(t){console.error("保存分类失败:",t),e.index.showToast({title:"保存失败: "+(t.message||"未知错误"),icon:"error"})}else e.index.showToast({title:"请输入分类名称",icon:"error"})},closeCategoryModal:()=>{d.value=!1,w()},deleteCategory:t=>{const r=h(t.id),a=r>0?`分类"${t.name}"下有${r}个商品，删除分类将同时删除所有商品，确定要删除吗？`:`确定要删除分类"${t.name}"吗？`;e.index.showModal({title:"确认删除",content:a,success:async r=>{if(r.confirm)try{await o.deleteCategory(t.id),e.index.showToast({title:"删除成功",icon:"success"}),await u()}catch(a){console.error("删除分类失败:",a),e.index.showToast({title:"删除失败",icon:"error"})}}})},showAddProductModal:(o=null)=>{if(console.log("显示添加商品弹窗",o),0!==r.value.length){if(v(),o){const e=r.value.findIndex((e=>e.id===o));e>-1&&(n.category=o,n.categoryIndex=e)}s.value=!0}else e.index.showToast({title:"请先添加分类",icon:"error"})},editProduct:e=>{n.id=e.id,n.name=e.name,n.price=e.price.toString(),n.category=e.category,n.categoryIndex=r.value.findIndex((o=>o.id===e.category)),n.description=e.description||"",n.imageUrl=p(e),s.value=!0},handleCategoryChange:e=>{var o;const t=e.detail?e.detail.value:e.target.value;n.categoryIndex=t,n.category=null==(o=r.value[t])?void 0:o.id,console.log("分类选择变化:",t,n.category)},chooseImage:()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{n.imageUrl=e.tempFilePaths[0],n.imageFile=e.tempFiles[0],console.log("选择图片:",e.tempFilePaths[0])},fail:o=>{console.error("选择图片失败:",o),o.errMsg&&o.errMsg.includes("cancel")?e.index.showToast({title:"图片留着不添加，谁知道长什么样",icon:"none",duration:2e3}):e.index.showToast({title:"选择图片失败",icon:"error"})}})},removeImage:()=>{n.imageUrl="",n.imageFile=null},uploadProductWithImage:P,saveProductModal:async()=>{if(console.log("保存商品开始",n),n.name.trim())if(!n.price||parseFloat(n.price)<=0)e.index.showToast({title:"请输入有效价格",icon:"error"});else if(n.category)try{const t={name:n.name.trim(),price:parseFloat(n.price),category:n.category,description:n.description.trim()};console.log("准备发送的商品数据:",t),n.id?(console.log("编辑商品:",n.id),n.imageFile?await P(n.id,t,n.imageUrl,!0):await o.updateProduct(n.id,t),e.index.showToast({title:"商品更新成功",icon:"success"})):(console.log("新增商品"),n.imageFile?await P(null,t,n.imageUrl,!1):await o.addProduct(t),e.index.showToast({title:"商品添加成功",icon:"success"})),s.value=!1,await y()}catch(t){console.error("保存商品失败:",t),e.index.showToast({title:"保存失败: "+(t.message||"未知错误"),icon:"error"})}else e.index.showToast({title:"请选择分类",icon:"error"});else e.index.showToast({title:"请输入商品名称",icon:"error"})},closeProductModal:()=>{s.value=!1,v()},deleteProduct:t=>{e.index.showModal({title:"确认删除",content:`确定要删除商品"${t.name}"吗？`,success:async r=>{if(r.confirm)try{await o.deleteProduct(t.id),e.index.showToast({title:"删除成功",icon:"success"}),await y()}catch(a){console.error("删除商品失败:",a),e.index.showToast({title:"删除失败",icon:"error"})}}})}}}};const a=e._export_sfc(r,[["render",function(o,t,r,a,c,i){return e.e({a:0===a.currentTab?1:"",b:e.o((e=>a.switchTab(0))),c:1===a.currentTab?1:"",d:e.o((e=>a.switchTab(1))),e:0===a.currentTab},0===a.currentTab?e.e({f:e.o(((...e)=>a.showAddCategoryModal&&a.showAddCategoryModal(...e))),g:e.f(a.categories,((o,t,r)=>({a:e.t(o.name),b:e.t(o.description||"暂无描述"),c:e.t(a.getCategoryProductCount(o.id)),d:e.o((e=>a.editCategory(o)),o.id),e:e.o((e=>a.deleteCategory(o)),o.id),f:o.id}))),h:0===a.categories.length},(a.categories.length,{})):{},{i:1===a.currentTab},1===a.currentTab?e.e({j:e.o(((...e)=>a.showAddProductModal&&a.showAddProductModal(...e))),k:e.f(a.products,((o,t,r)=>({a:a.getProductImageUrl(o),b:e.t(o.name),c:e.t(o.category_name||"未知分类"),d:e.t(o.price),e:e.o((e=>a.editProduct(o)),o.id),f:e.o((e=>a.deleteProduct(o)),o.id),g:o.id}))),l:0===a.products.length},(a.products.length,{})):{},{m:a.showCategoryModal},a.showCategoryModal?{n:e.t(a.categoryForm.id?"编辑分类":"添加分类"),o:e.o(((...e)=>a.closeCategoryModal&&a.closeCategoryModal(...e))),p:a.categoryForm.name,q:e.o((e=>a.categoryForm.name=e.detail.value)),r:a.categoryForm.description,s:e.o((e=>a.categoryForm.description=e.detail.value)),t:e.o(((...e)=>a.closeCategoryModal&&a.closeCategoryModal(...e))),v:e.o(((...e)=>a.saveCategoryModal&&a.saveCategoryModal(...e))),w:e.o((()=>{})),x:e.o(((...e)=>a.closeCategoryModal&&a.closeCategoryModal(...e)))}:{},{y:a.showProductModal},a.showProductModal?e.e({z:e.t(a.productForm.id?"编辑商品":"添加商品"),A:e.o(((...e)=>a.closeProductModal&&a.closeProductModal(...e))),B:a.productForm.name,C:e.o((e=>a.productForm.name=e.detail.value)),D:a.productForm.price,E:e.o((e=>a.productForm.price=e.detail.value)),F:e.t(a.categoryOptions[a.productForm.categoryIndex]||"请选择分类"),G:a.productForm.categoryIndex,H:a.categoryOptions,I:e.o(((...e)=>a.handleCategoryChange&&a.handleCategoryChange(...e))),J:a.productForm.description,K:e.o((e=>a.productForm.description=e.detail.value)),L:a.productForm.imageUrl},a.productForm.imageUrl?{M:a.productForm.imageUrl}:{},{N:e.o(((...e)=>a.chooseImage&&a.chooseImage(...e))),O:a.productForm.imageUrl},a.productForm.imageUrl?{P:e.o(((...e)=>a.removeImage&&a.removeImage(...e)))}:{},{Q:e.o(((...e)=>a.closeProductModal&&a.closeProductModal(...e))),R:e.o(((...e)=>a.saveProductModal&&a.saveProductModal(...e))),S:e.o((()=>{})),T:e.o(((...e)=>a.closeProductModal&&a.closeProductModal(...e)))}):{})}],["__scopeId","data-v-82aa4ffc"]]);wx.createPage(a);
