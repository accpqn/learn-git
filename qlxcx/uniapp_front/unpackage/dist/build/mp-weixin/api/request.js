"use strict";const e=require("../common/vendor.js"),r=require("../store/user.js"),s=require("../config/index.js"),o=`${s.config.API_BASE_URL}/api`;exports.request=n=>{const t=r.useUserStore();return new Promise(((r,i)=>{n.url=`${o}${n.url}`,n.header={"Content-Type":"application/json",...n.header};const a=!["/users/login/","/users/verify-and-login/","/users/send-code/","/token/refresh/"].some((e=>n.url.includes(e)));t.token&&a&&(n.header.Authorization=`Bearer ${t.token}`),e.index.request({...n,timeout:s.config.REQUEST_TIMEOUT,success:async s=>{if(401===s.statusCode&&!n.url.includes("/token/refresh"))try{if(await t.refreshUserToken())return n.header.Authorization=`Bearer ${t.token}`,void e.index.request({...n,success:e=>{r(e.data)},fail:e=>{i(e)}})}catch(o){return t.clearUserState(),e.index.reLaunch({url:"/pages/public/login"}),void i(new Error("登录已过期，请重新登录"))}if(s.statusCode>=400){const e=new Error(s.data.message||s.data.detail||"请求失败");return e.response=s,void i(e)}r(s.data)},fail:r=>{console.error("Request failed:",r);let s="网络错误";r.errMsg&&(r.errMsg.includes("timeout")?s="请求超时，请检查网络连接":r.errMsg.includes("fail")&&(s="连接服务器失败")),e.index.showToast({title:s,icon:"none",duration:3e3});const o=new Error(s);o.originalError=r,i(o)}})}))};
